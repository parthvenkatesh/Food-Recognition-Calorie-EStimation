{"ast":null,"code":"var _jsxFileName = \"/home/parth/Documents/Food-Detect/src/App.js\";\nimport React, { Component } from 'react';\nimport './App.css';\nimport ndarray from 'ndarray';\nimport ops from 'ndarray-ops';\nimport { food101topK } from './utils';\nimport { con } from './utils';\nconst loadImage = window.loadImage;\n\nconst mapProb = prob => {\n  if (prob * 100 < 2) {\n    return '2%';\n  } else {\n    return prob * 100 + '%';\n  }\n};\n\nconst Predictions = ({\n  topK\n}) => {\n  return React.createElement(\"center\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 22\n    },\n    __self: this\n  }, React.createElement(\"table\", {\n    className: \"predictions\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 22\n    },\n    __self: this\n  }, React.createElement(\"tbody\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 23\n    },\n    __self: this\n  }, React.createElement(\"tr\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 24\n    },\n    __self: this\n  }, React.createElement(\"th\", {\n    className: \"th\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 25\n    },\n    __self: this\n  }, \"Prediction\"), React.createElement(\"th\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 26\n    },\n    __self: this\n  }, \"Calories you consumed\")), topK.map((pred, i) => React.createElement(\"tr\", {\n    key: i,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 29\n    },\n    __self: this\n  }, React.createElement(\"td\", {\n    className: \"predLabel\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 30\n    },\n    __self: this\n  }, pred.name), React.createElement(\"td\", {\n    className: \"predPercent\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 31\n    },\n    __self: this\n  }, React.createElement(\"span\", {\n    className: \"predPercentLabel\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 32\n    },\n    __self: this\n  }, con(pred.name)), React.createElement(\"div\", {\n    className: \"predBar\",\n    style: {\n      width: mapProb(pred.probability)\n    },\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 33\n    },\n    __self: this\n  })))))));\n};\n\nclass App extends Component {\n  constructor() {\n    super();\n\n    this.loadModel = () => {\n      console.log('Loading Model');\n      const model = new window.KerasJS.Model({\n        filepaths: {\n          model: 'model.json',\n          weights: 'https://s3.amazonaws.com/stratospark/food-101/model4b.10-0.68_weights.buf',\n          metadata: 'model4b.10-0.68_metadata.json'\n        },\n        gpu: this.state.hasWebgl,\n        layerCallPauses: true\n      });\n      let interval = setInterval(() => {\n        const percent = model.getLoadingProgress();\n        console.log('Progress', percent, model.xhrProgress);\n        this.setState({\n          loadingPercent: percent\n        });\n      }, 100);\n      const waitTillReady = model.ready();\n      waitTillReady.then(() => {\n        clearInterval(interval);\n        console.log('Model ready');\n        this.setState({\n          loadingPercent: 100,\n          modelLoading: false,\n          modelLoaded: true\n        });\n        setTimeout(() => this.loadImageToCanvas(), 100);\n      }).catch(err => {\n        clearInterval(interval);\n        console.log('err', err);\n      });\n      this.setState({\n        modelLoading: true,\n        model\n      });\n    };\n\n    this.loadImageToCanvas = () => {\n      console.log('Loading Image');\n      var file = document.getElementById('file');\n\n      if (!file.value) {\n        return;\n      }\n\n      ;\n      this.setState({\n        imageLoadingError: false,\n        imageLoading: true,\n        loadingPercent: 0,\n        classifyPercent: 0,\n        topK: null\n      });\n      var input,\n          file,\n          fr,\n          img,\n          success = true;\n      input = document.getElementById('file');\n\n      if (!input) {\n        alert(\"Um, couldn't find the imgfile element.\");\n        success = false;\n      } else if (!input.files) {\n        alert(\"This browser doesn't seem to support the `files` property of file inputs.\");\n        success = false;\n      } else if (!input.files[0]) {\n        alert(\"Please select a file before clicking 'Load'\");\n        success = false;\n      } else {\n        file = input.files[0];\n        fr = new FileReader();\n        fr.onload = createImage;\n        fr.readAsDataURL(file);\n      }\n\n      function createImage() {\n        img = new Image();\n        img.onload = imageLoaded;\n        img.src = fr.result;\n      }\n\n      function imageLoaded() {\n        var canvas = document.getElementById(\"input-canvas\");\n        canvas.width = 299;\n        canvas.height = 299;\n        var ctx = canvas.getContext(\"2d\");\n        ctx.drawImage(img, 0, 0, 299, 299);\n      }\n\n      if (success) this.setState({\n        imageLoadingError: false,\n        imageLoading: false,\n        modelRunning: true\n      });else this.setState({\n        imageLoadingError: true,\n        imageLoading: false,\n        modelRunning: false\n      });\n    };\n\n    this.runModel = () => {\n      console.log('Running Model');\n      const ctx = document.getElementById('input-canvas').getContext('2d');\n      const imageData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);\n      const data = imageData.data,\n            width = imageData.width,\n            height = imageData.height;\n      let dataTensor = ndarray(new Float32Array(data), [width, height, 4]);\n      let dataProcessedTensor = ndarray(new Float32Array(width * height * 3), [width, height, 3]);\n      ops.divseq(dataTensor, 255);\n      ops.subseq(dataTensor, 0.5);\n      ops.mulseq(dataTensor, 2);\n      ops.assign(dataProcessedTensor.pick(null, null, 0), dataTensor.pick(null, null, 0));\n      ops.assign(dataProcessedTensor.pick(null, null, 1), dataTensor.pick(null, null, 1));\n      ops.assign(dataProcessedTensor.pick(null, null, 2), dataTensor.pick(null, null, 2));\n      const inputData = {\n        input_1: dataProcessedTensor.data\n      };\n      const predPromise = this.state.model.predict(inputData);\n      const totalLayers = Object.keys(this.state.model.modelDAG).length;\n      let interval = setInterval(() => {\n        const completedLayers = this.state.model.layersWithResults.length;\n        this.setState({\n          classifyPercent: (completedLayers / totalLayers * 100).toFixed(2)\n        });\n      }, 50);\n      predPromise.then(outputData => {\n        console.log(outputData);\n        clearInterval(interval);\n        const preds = outputData['dense_1'];\n        const topK = food101topK(preds, 1);\n        console.log(topK);\n        this.setState({\n          topK,\n          modelRunning: false\n        });\n      });\n    };\n\n    this.classifyNewImage = () => {\n      console.log('classifying new image');\n      this.loadImageToCanvas();\n      setTimeout(function () {\n        this.runModel();\n      }, 1000);\n    };\n\n    let hasWebgl = false;\n\n    const _canvas = document.createElement('canvas');\n\n    const gl = _canvas.getContext('webgl') || _canvas.getContext('experimental-webgl'); // Report the result.\n\n\n    if (gl && gl instanceof WebGLRenderingContext) {\n      hasWebgl = true;\n    } else {\n      hasWebgl = false;\n    }\n\n    console.log('WebGL enabled:', hasWebgl);\n    this.urlInput = null;\n    this.state = {\n      model: null,\n      modelLoaded: false,\n      modelLoading: false,\n      modelRunning: false,\n      imageLoadingError: false,\n      loadingPercent: 0,\n      classifyPercent: 0,\n      topK: null,\n      hasWebgl\n    };\n  }\n\n  render() {\n    const _this$state = this.state,\n          loadingPercent = _this$state.loadingPercent,\n          modelLoaded = _this$state.modelLoaded,\n          modelLoading = _this$state.modelLoading,\n          modelRunning = _this$state.modelRunning,\n          imageLoading = _this$state.imageLoading,\n          imageLoadingError = _this$state.imageLoadingError,\n          classifyPercent = _this$state.classifyPercent,\n          topK = _this$state.topK;\n    return React.createElement(\"div\", {\n      className: \"App\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 258\n      },\n      __self: this\n    }, React.createElement(\"center\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 259\n      },\n      __self: this\n    }, React.createElement(\"h1\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 259\n      },\n      __self: this\n    }, \"Food Recognition with Calorie Estimation\")), !modelLoaded ? React.createElement(\"p\", {\n      className: \"intro\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 261\n      },\n      __self: this\n    }, React.createElement(\"center\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 262\n      },\n      __self: this\n    }, \"To get started, click the Load Model button to load the model.\")) : '', React.createElement(\"div\", {\n      className: \"init\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 265\n      },\n      __self: this\n    }, !modelLoaded && !modelLoading ? React.createElement(\"center\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 266\n      },\n      __self: this\n    }, React.createElement(\"button\", {\n      onClick: this.loadModel,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 266\n      },\n      __self: this\n    }, \"Load Model (85 MB)\")) : '', !modelLoaded && modelLoading ? React.createElement(\"p\", {\n      className: \"loading\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 268\n      },\n      __self: this\n    }, React.createElement(\"center\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 268\n      },\n      __self: this\n    }, \"LOADING MODEL: \", loadingPercent, \"%\")) : '', modelLoaded && imageLoading ? React.createElement(\"p\", {\n      className: \"loading\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 271\n      },\n      __self: this\n    }, \"LOADING IMAGE\") : '', modelLoaded && imageLoadingError ? React.createElement(\"p\", {\n      className: \"error\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 274\n      },\n      __self: this\n    }, React.createElement(\"center\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 274\n      },\n      __self: this\n    }, \"ERROR LOADING IMAGE.\", React.createElement(\"br\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 274\n      },\n      __self: this\n    }), \"TRY DIFFERENT URL\")) : '', modelLoaded && modelRunning ? React.createElement(\"p\", {\n      className: \"loading\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 277\n      },\n      __self: this\n    }, React.createElement(\"center\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 277\n      },\n      __self: this\n    }, \"CLASSIFYING: \", classifyPercent, \"%\")) : ''), React.createElement(\"div\", {\n      className: \"interactive\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 280\n      },\n      __self: this\n    }, modelLoaded && !modelRunning && !imageLoading ? React.createElement(\"p\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 282\n      },\n      __self: this\n    }, React.createElement(\"center\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 283\n      },\n      __self: this\n    }, \"Food Image URL: \", React.createElement(\"input\", {\n      type: \"file\",\n      id: \"file\",\n      ref: input => {\n        this.urlInput = input;\n      },\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 283\n      },\n      __self: this\n    }), React.createElement(\"br\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 284\n      },\n      __self: this\n    }), React.createElement(\"br\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 284\n      },\n      __self: this\n    }), React.createElement(\"button\", {\n      onClick: this.classifyNewImage,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 285\n      },\n      __self: this\n    }, \"Classify Image\"))) : '', React.createElement(\"center\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 288\n      },\n      __self: this\n    }, React.createElement(\"canvas\", {\n      id: \"input-canvas\",\n      width: \"299\",\n      height: \"299\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 288\n      },\n      __self: this\n    })), topK ? React.createElement(Predictions, {\n      topK: topK,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 289\n      },\n      __self: this\n    }) : ''));\n  }\n\n}\n\nexport default App;","map":{"version":3,"sources":["/home/parth/Documents/Food-Detect/src/App.js"],"names":["React","Component","ndarray","ops","food101topK","con","loadImage","window","mapProb","prob","Predictions","topK","map","pred","i","name","width","probability","App","constructor","loadModel","console","log","model","KerasJS","Model","filepaths","weights","metadata","gpu","state","hasWebgl","layerCallPauses","interval","setInterval","percent","getLoadingProgress","xhrProgress","setState","loadingPercent","waitTillReady","ready","then","clearInterval","modelLoading","modelLoaded","setTimeout","loadImageToCanvas","catch","err","file","document","getElementById","value","imageLoadingError","imageLoading","classifyPercent","input","fr","img","success","alert","files","FileReader","onload","createImage","readAsDataURL","Image","imageLoaded","src","result","canvas","height","ctx","getContext","drawImage","modelRunning","runModel","imageData","getImageData","data","dataTensor","Float32Array","dataProcessedTensor","divseq","subseq","mulseq","assign","pick","inputData","input_1","predPromise","predict","totalLayers","Object","keys","modelDAG","length","completedLayers","layersWithResults","toFixed","outputData","preds","classifyNewImage","createElement","gl","WebGLRenderingContext","urlInput","render"],"mappings":"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","sourcesContent":["import React, { Component } from 'react';\nimport './App.css';\n\nimport ndarray from 'ndarray';\nimport ops from 'ndarray-ops';\n\nimport { food101topK } from './utils';\nimport { con } from './utils';\n\nconst loadImage = window.loadImage;\n\nconst mapProb = (prob) => {\n  if (prob * 100 < 2) {\n    return '2%';\n  } else {\n    return (prob * 100 + '%');\n  }\n}\n\nconst Predictions = ({topK}) => {\n  return (\n    <center><table className='predictions'>\n      <tbody>\n      <tr>\n        <th className='th'>Prediction</th>\n        <th>Calories you consumed</th>\n      </tr>\n      { topK.map((pred, i) =>\n        <tr key={i}>\n          <td className='predLabel'>{pred.name}</td>\n          <td className='predPercent'>\n            <span className='predPercentLabel'>{con(pred.name)}</span>\n            <div className='predBar' style={{width: mapProb(pred.probability)}}/>\n          </td>\n        </tr>\n      )}\n      </tbody>\n    </table></center>\n  );\n}\n\nclass App extends Component {\n\n  constructor() {\n    super();\n\n    let hasWebgl = false;\n    const canvas = document.createElement('canvas');\n    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');\n    // Report the result.\n    if (gl && gl instanceof WebGLRenderingContext) {\n      hasWebgl = true;\n    } else {\n      hasWebgl = false;\n    }\n    console.log('WebGL enabled:', hasWebgl);\n\n    this.urlInput = null;\n    this.state = {\n      model: null,\n      modelLoaded: false,\n      modelLoading: false,\n      modelRunning: false,\n      imageLoadingError: false,\n      loadingPercent: 0,\n      classifyPercent: 0,\n      topK: null,\n      hasWebgl\n    };\n  }\n\n  loadModel = () => {\n    console.log('Loading Model');\n    const model = new window.KerasJS.Model({\n      filepaths: {\n        model: 'model.json' ,\n        weights: 'https://s3.amazonaws.com/stratospark/food-101/model4b.10-0.68_weights.buf',\n        metadata: 'model4b.10-0.68_metadata.json'\n      },\n      gpu: this.state.hasWebgl,\n      layerCallPauses: true\n    });\n\n    let interval = setInterval(() => {\n      const percent = model.getLoadingProgress();\n      console.log('Progress', percent, model.xhrProgress);\n      this.setState({\n        loadingPercent: percent\n      });\n    }, 100);\n\n    const waitTillReady = model.ready();\n\n    waitTillReady.then(() => {\n      clearInterval(interval);\n      console.log('Model ready');\n      this.setState({\n        loadingPercent: 100,\n        modelLoading: false,\n        modelLoaded: true\n      });\n\n      setTimeout(() => this.loadImageToCanvas(), 100);\n    })\n    .catch(err => {\n      clearInterval(interval);\n      console.log('err', err);\n    });\n\n    this.setState({\n      modelLoading: true,\n      model\n    });\n  }\n\n  loadImageToCanvas = () => {\n    console.log('Loading Image');\n    var file = document.getElementById('file')\n    if (!file.value) {\n      return;\n    };\n\n    this.setState({\n      imageLoadingError: false,\n      imageLoading: true,\n      loadingPercent: 0,\n      classifyPercent: 0,\n      topK: null\n    });\n      \n      var input, file, fr, img,success=true;\n      input = document.getElementById('file');\n      if (!input) {\n            alert(\"Um, couldn't find the imgfile element.\");\n\t\tsuccess=false;\n        }\n        else if (!input.files) {\n            alert(\"This browser doesn't seem to support the `files` property of file inputs.\");\n\t\tsuccess=false;\n        }\n        else if (!input.files[0]) {\n            alert(\"Please select a file before clicking 'Load'\");\n\t\tsuccess=false;\n        }\n        else {\n            file = input.files[0];\n            fr = new FileReader();\n            fr.onload = createImage;\n            fr.readAsDataURL(file);\n        }\n        function createImage() {\n            img = new Image();\n            img.onload = imageLoaded;\n            img.src = fr.result;\n        }\n\n        function imageLoaded() {\n            var canvas = document.getElementById(\"input-canvas\")\n            canvas.width = 299;\n            canvas.height = 299;\n            var ctx = canvas.getContext(\"2d\");\n            ctx.drawImage(img,0,0,299,299);\n        }\n\tif(success)\n\t\tthis.setState({\n            imageLoadingError: false,\n            imageLoading: false,\n            modelRunning: true\n          });\n\telse\n\t\t this.setState({\n            imageLoadingError: true,\n            imageLoading: false,\n            modelRunning: false\n          });\n\n\n  }\n\n  runModel = () => {\n    console.log('Running Model');\n\n    const ctx = document.getElementById('input-canvas').getContext('2d');\n    const imageData = ctx.getImageData(\n      0,\n      0,\n      ctx.canvas.width,\n      ctx.canvas.height\n    );\n    const { data, width, height } = imageData;\n\n    let dataTensor = ndarray(new Float32Array(data), [ width, height, 4 ]);\n    let dataProcessedTensor = ndarray(new Float32Array(width * height * 3), [\n      width,\n      height,\n      3\n    ]);\n    ops.divseq(dataTensor, 255);\n    ops.subseq(dataTensor, 0.5);\n    ops.mulseq(dataTensor, 2);\n    ops.assign(\n      dataProcessedTensor.pick(null, null, 0),\n      dataTensor.pick(null, null, 0)\n    );\n    ops.assign(\n      dataProcessedTensor.pick(null, null, 1),\n      dataTensor.pick(null, null, 1)\n    );\n    ops.assign(\n      dataProcessedTensor.pick(null, null, 2),\n      dataTensor.pick(null, null, 2)\n    );\n\n    const inputData = { input_1: dataProcessedTensor.data };\n    const predPromise = this.state.model.predict(inputData);\n\n    const totalLayers = Object.keys(this.state.model.modelDAG).length\n    let interval = setInterval(() => {\n      const completedLayers = this.state.model.layersWithResults.length;\n      this.setState({\n        classifyPercent: ((completedLayers / totalLayers) * 100).toFixed(2)\n      });\n    }, 50);\n\n    predPromise.then(outputData => {\n      console.log(outputData);\n      clearInterval(interval);\n      const preds = outputData['dense_1'];\n      const topK = food101topK(preds,1);\n      console.log(topK);\n      this.setState({\n        topK,\n        modelRunning: false\n      });\n    });\n  }\n\n  classifyNewImage = () => {\n    console.log('classifying new image', );\n    this.loadImageToCanvas();\n\tsetTimeout(function(){\n\tthis.runModel();\n\t}, 1000);\n  }\n\n  render() {\n    const {\n      loadingPercent,\n      modelLoaded,\n      modelLoading,\n      modelRunning,\n      imageLoading,\n      imageLoadingError,\n      classifyPercent,\n      topK\n    } = this.state;\n    return (\n      <div className=\"App\">\n        <center><h1>Food Recognition with Calorie Estimation</h1></center>\n        { !modelLoaded ?\n        <p className='intro'>\n          <center>To get started, click the Load Model button to load the model.</center>\n        </p>\n        : ''}\n        <div className='init'>\n        { !modelLoaded && !modelLoading ? <center><button onClick={this.loadModel}>Load Model (85 MB)</button></center> : ''}\n        { !modelLoaded && modelLoading ?\n          <p className='loading'><center>LOADING MODEL: {loadingPercent}%</center></p>\n          : ''}\n        { modelLoaded && imageLoading ?\n          <p className='loading'>LOADING IMAGE</p>\n          : ''}\n        { modelLoaded && imageLoadingError ?\n          <p className='error'><center>ERROR LOADING IMAGE.<br/>TRY DIFFERENT URL</center></p>\n          : ''}\n        { modelLoaded && modelRunning ?\n          <p className='loading'><center>CLASSIFYING: {classifyPercent}%</center></p>\n          : ''}\n        </div>\n        <div className='interactive'>\n          { modelLoaded && !modelRunning && !imageLoading ?\n          <p>\n            <center>Food Image URL: <input type='file' id='file' ref={(input) => { this.urlInput = input; }}/>\n            <br/><br/>\n            <button onClick={this.classifyNewImage}>Classify Image</button></center>\n          </p>\n          : '' }\n          <center><canvas id='input-canvas' width='299' height='299'/></center>\n          { topK ? <Predictions topK={topK}/> : ''}\n        </div>\n      </div>\n    );\n  }\n}\n\nexport default App;\n"]},"metadata":{},"sourceType":"module"}